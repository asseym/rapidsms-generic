{% load timeslider_tags %}
<p>
    Date Range:<span id="date_slider_value" class="daterange">From {{ start_date|date:"Y-m-d" }} to {{ end_date|date:"Y-m-d" }}</span>
    <a href="javascript:void(0)" onclick="previous_date_range('w');"> &laquo; previous week</a> |
    <a href="javascript:void(0)" onclick="previous_date_range('m');"> &laquo; previous month</a>
    <script language="javascript">
    function update_date_layers() {
        selected_start_date = $("select#start option:selected").val() / 1000;
        selected_end_date = $("select#end option:selected").val() / 1000;
        {% for layer in map_layers %}
            {% if layer.needs_date %}
                if ($('#map_layers input[name="layer{{ forloop.counter0 }}"]:checked').length) {
                    {% autoescape off %}
                        plot_layer_with_date(
                            'map',
                            '{{ layer.name }}',
                            '{{ layer.url }}',
                            selected_start_date,
                            selected_end_date);
                    {% endautoescape %}
                }
            {% endif %}
       {% endfor %}
    }
    </script>
    <a href="javascript:void(0)" onclick="update_date_layers();" style="float:right">update</a>
</p>
<div id="date_slider" style="margin: 5px 5px 80px 5px">
{% for sel_ts, sel_name in selected_ts %}
    <label for="{{ sel_name }}"></label>
    <select name="{{ sel_name }}" id="{{ sel_name }}" style="display:none">
        {% for i in ts_range %}
            {% if forloop.first %}
                <optgroup label="{{ i|to_date|year }}">
                    <optgroup label="{{ i|to_date|date:"M" }}">
            {% else %}
                {% ifequal i|to_date|day 1 %}
                        </optgroup>
                    {% ifequal i|to_date|month 1 %}
                        </optgroup>
                        <optgroup label="{{ i|to_date|year }}">
                    {% endifequal %}
                        <optgroup label="{{ i|to_date|date:"M" }}">
                {% endifequal %}
            {% endif %}
            <option value="{{ i }}"
            {% ifequal i sel_ts %}selected="true"{% endifequal %}>
                {{ i|to_date|date:"d-M-Y" }}
            </option>
            {% if forloop.last %}
                    </optgroup>
                </optgroup>
            {% endif %}
        {% endfor %}
    </select>
{% endfor %}
</div>
<script language="javascript">
    //$('#date_slider').append(slider_select_box('start', {{ min_ts }}, {{ max_ts }}, {{ start_ts }}));
    //$('#date_slider').append(slider_select_box('end', {{ min_ts }}, {{ max_ts }}, {{ end_ts }}));    
    $(function() {
        //initialise ui slider
    	$('select#start, select#end').selectToUISlider({
            labels: 0,
    		sliderOptions: {
    		    change:function(e, ui) {
        		    start_date=new Date(parseInt($('select#start option').eq(ui.values[0])[0].value));
                    start_str = start_date.getDate() + "-" + (start_date.getMonth() + 1) + "-" + start_date.getFullYear();
        		    end_date=new Date(parseInt($('select#end option').eq(ui.values[1])[0].value));
                    end_str = end_date.getDate() + "-" + (end_date.getMonth() + 1) + "-" + end_date.getFullYear();
                    $('#id_start_ts').val(parseInt($('select#start option').eq(ui.values[0])[0].value));
                    $('#id_end_ts').val(parseInt($('select#end option').eq(ui.values[1])[0].value));
                    $( "#date_slider_value" ).text( "From " + start_str + " to " + end_str );
    	        }
            }
    	});
    	var min_timestamp = {{ min_ts }};
    	var min_sdt = new Date(min_timestamp);
    	if(min_sdt.getDay() !== 1){
    		offset = 7 - min_sdt.getDay();
    	}else{
    		offset = 0;
    	}
        tickEvery(7, offset);

        start_date = new Date({{ start_ts }});
        start_str = start_date.getDate() + "-" + (start_date.getMonth() + 1) + "-" + start_date.getFullYear();
        end_date = new Date({{ end_ts }});
        end_str = end_date.getDate() + "-" + (end_date.getMonth() + 1) + "-" + end_date.getFullYear();
        $('#id_start_ts').val('' + {{ start_ts }});
        $('#id_end_ts').val('' + {{ end_ts }});
        $( "#date_slider_value" ).text( "From " + start_str +
            " to " + end_str );
    });
</script>